<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Markdown Notes</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg-primary: #ffffff;
                --bg-secondary: #f5f5f5;
                --text-primary: #000000;
                --text-secondary: #666666;
                --border-color: #e0e0e0;
                --accent-color: #0066cc;
                --accent-hover: #0052a3;
                --input-bg: #ffffff;
                --input-border: #cccccc;
                --hljs-bg: #f5f5f5;
            }

            body.dark-mode {
                --bg-primary: #1e1e1e;
                --bg-secondary: #2d2d2d;
                --text-primary: #e0e0e0;
                --text-secondary: #a0a0a0;
                --border-color: #404040;
                --accent-color: #66b3ff;
                --accent-hover: #5299cc;
                --input-bg: #2d2d2d;
                --input-border: #404040;
                --hljs-bg: #1e1e1e;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                background-color: var(--bg-primary);
                color: var(--text-primary);
                height: 100vh;
                overflow: hidden;
                transition: background-color 0.3s, color 0.3s;
            }

            .container {
                display: flex;
                height: 100vh;
                flex-direction: column;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 16px;
                background-color: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                gap: 16px;
            }

            .header h1 {
                font-size: 18px;
                font-weight: 600;
            }

            .theme-toggle {
                background: none;
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }

            .theme-toggle:hover {
                background-color: var(--bg-primary);
            }

            .header-actions {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .header-btn {
                background: none;
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }

            .header-btn:hover {
                background-color: var(--bg-primary);
            }

            #importFile {
                display: none;
            }

            .main-content {
                display: flex;
                flex: 1;
                overflow: hidden;
            }

            .sidebar {
                width: 300px;
                display: flex;
                flex-direction: column;
                border-right: 1px solid var(--border-color);
                background-color: var(--bg-secondary);
            }

            .sidebar-header {
                padding: 12px 16px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                gap: 8px;
            }

            .new-note-btn {
                flex: 1;
                padding: 8px 12px;
                background-color: var(--accent-color);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                transition: background-color 0.2s;
            }

            .new-note-btn:hover {
                background-color: var(--accent-hover);
            }

            .notes-list {
                flex: 1;
                overflow-y: auto;
                list-style: none;
            }

            .note-item {
                padding: 12px 16px;
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
                transition: background-color 0.2s;
                user-select: none;
            }

            .note-item:hover {
                background-color: var(--bg-primary);
            }

            .note-item.active {
                background-color: var(--accent-color);
                color: white;
            }

            .note-item-title {
                font-weight: 500;
                margin-bottom: 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .note-item-date {
                font-size: 12px;
                opacity: 0.7;
            }

            .note-item.active .note-item-date {
                color: rgba(255, 255, 255, 0.8);
            }

            .note-item-actions {
                display: none;
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                background: inherit;
                border-left: 1px solid var(--border-color);
                padding: 12px 8px;
                gap: 4px;
            }

            .note-item:hover .note-item-actions {
                display: flex;
                align-items: center;
            }

            .delete-note-btn {
                background: none;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                font-size: 14px;
                padding: 4px 8px;
                border-radius: 3px;
                transition: all 0.2s;
            }

            .delete-note-btn:hover {
                background-color: #ff4444;
                color: white;
            }

            .editor-pane {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .editor-toolbar {
                padding: 8px 16px;
                background-color: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                font-size: 12px;
                color: var(--text-secondary);
            }

            .editor-content {
                flex: 1;
                display: flex;
                overflow: hidden;
                position: relative;
            }

            .editor-wrapper {
                flex: 1;
                position: relative;
                overflow: hidden;
            }

            .editor-highlight {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 16px;
                font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
                font-size: 14px;
                background-color: var(--input-bg);
                color: var(--text-primary);
                overflow: hidden;
                pointer-events: none;
                white-space: pre-wrap;
                word-wrap: break-word;
                z-index: 1;
            }

            .editor-highlight code {
                background: none;
                color: inherit;
                padding: 0;
                font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
                font-size: 14px;
            }

            .editor-input {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 16px;
                font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
                font-size: 14px;
                border: none;
                background-color: transparent;
                color: transparent;
                resize: none;
                outline: none;
                z-index: 2;
                caret-color: var(--text-primary);
                overflow: auto;
            }

            /* Markdown syntax highlighting colors */
            .md-header {
                color: #0066cc;
                font-weight: bold;
            }

            .md-bold {
                font-weight: bold;
            }

            .md-italic {
                font-style: italic;
            }

            .md-code {
                background-color: var(--hljs-bg);
                color: #d4d4d4;
            }

            .md-link {
                color: #0066cc;
                text-decoration: underline;
            }

            .md-url {
                color: #008000;
            }

            .md-list {
                color: #666666;
            }

            .md-blockquote {
                color: #999999;
                font-style: italic;
            }

            body.dark-mode .md-header {
                color: #66b3ff;
            }

            body.dark-mode .md-code {
                color: #b4d4ff;
            }

            body.dark-mode .md-link {
                color: #66b3ff;
            }

            body.dark-mode .md-url {
                color: #4ec9b0;
            }

            body.dark-mode .md-list {
                color: #a0a0a0;
            }

            body.dark-mode .md-blockquote {
                color: #707070;
            }

            .preview-pane {
                width: 50%;
                padding: 16px;
                overflow-y: auto;
                border-left: 1px solid var(--border-color);
                background-color: var(--bg-primary);
            }

            .preview-pane h1 {
                font-size: 24px;
                margin: 16px 0 8px 0;
                margin-top: 0;
            }

            .preview-pane h2 {
                font-size: 20px;
                margin: 14px 0 6px 0;
            }

            .preview-pane h3 {
                font-size: 18px;
                margin: 12px 0 4px 0;
            }

            .preview-pane h4,
            .preview-pane h5,
            .preview-pane h6 {
                font-size: 16px;
                margin: 10px 0 4px 0;
            }

            .preview-pane p {
                margin-bottom: 12px;
                line-height: 1.6;
            }

            .preview-pane ul,
            .preview-pane ol {
                margin-left: 24px;
                margin-bottom: 12px;
                line-height: 1.6;
            }

            .preview-pane li {
                margin-bottom: 6px;
            }

            .preview-pane code {
                background-color: var(--hljs-bg);
                padding: 2px 6px;
                border-radius: 3px;
                font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
                font-size: 13px;
            }

            .preview-pane pre {
                background-color: var(--hljs-bg);
                padding: 12px;
                border-radius: 4px;
                overflow-x: auto;
                margin-bottom: 12px;
            }

            .preview-pane pre code {
                background-color: transparent;
                padding: 0;
                border-radius: 0;
            }

            .preview-pane blockquote {
                border-left: 3px solid var(--accent-color);
                padding-left: 12px;
                margin-left: 0;
                margin-bottom: 12px;
                color: var(--text-secondary);
                font-style: italic;
            }

            .preview-pane a {
                color: var(--accent-color);
                text-decoration: none;
            }

            .preview-pane a:hover {
                text-decoration: underline;
            }

            .preview-pane hr {
                border: none;
                border-top: 1px solid var(--border-color);
                margin: 16px 0;
            }

            /* Scrollbar styling */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background-color: var(--border-color);
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background-color: var(--text-secondary);
            }

            /* Dark mode syntax highlighting */
            body.dark-mode .hljs {
                background: var(--hljs-bg);
                color: #e0e0e0;
            }

            /* Light mode syntax highlighting */
            body:not(.dark-mode) .hljs {
                background: var(--hljs-bg);
            }

            .empty-state {
                display: flex;
                align-items: center;
                justify-content: center;
                flex: 1;
                text-align: center;
                color: var(--text-secondary);
            }

            .empty-state p {
                font-size: 16px;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="header">
                <h1>üìù Markdown Notes</h1>
                <div class="header-actions">
                    <button class="header-btn" id="exportAllBtn" title="Export all notes as JSON">‚¨áÔ∏è Export All</button>
                    <button class="header-btn" id="importBtn" title="Import notes from JSON">‚¨ÜÔ∏è Import</button>
                    <input type="file" id="importFile" accept=".json" />
                    <button class="theme-toggle" id="themeToggle">üåô Dark Mode</button>
                </div>
            </div>
            <div class="main-content">
                <div class="sidebar">
                    <div class="sidebar-header">
                        <button class="new-note-btn" id="newNoteBtn">+ New Note</button>
                    </div>
                    <ul class="notes-list" id="notesList"></ul>
                </div>
                <div class="editor-pane">
                    <div class="editor-toolbar" id="editorToolbar">
                        Select a note or create a new one
                    </div>
                    <div class="editor-content" id="editorContent" style="display: none;">
                        <div class="editor-wrapper">
                            <div class="editor-highlight" id="editorHighlight"></div>
                            <textarea class="editor-input" id="editorInput" placeholder="Write your markdown here..."></textarea>
                        </div>
                        <div class="preview-pane" id="previewPane"></div>
                    </div>
                    <div class="empty-state" id="emptyState">
                        <p>Create a new note to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Database setup
            const DB_NAME = 'MarkdownNotesDB';
            const STORE_NAME = 'notes';
            const CONFIG_STORE = 'config';
            let db;

            // Initialize database
            function initDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 1);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        db = request.result;
                        resolve(db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('createdAt', 'createdAt', { unique: false });
                            store.createIndex('modifiedAt', 'modifiedAt', { unique: false });
                        }
                        if (!db.objectStoreNames.contains(CONFIG_STORE)) {
                            db.createObjectStore(CONFIG_STORE);
                        }
                    };
                });
            }

            // Database operations
            function getAllNotes() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        resolve(request.result.sort((a, b) => b.modifiedAt - a.modifiedAt));
                    };
                });
            }

            function getNote(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(id);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            }

            function saveNote(note) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = note.id ? store.put(note) : store.add(note);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            }

            function deleteNote(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            }

            function getSelectedNoteId() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([CONFIG_STORE], 'readonly');
                    const store = transaction.objectStore(CONFIG_STORE);
                    const request = store.get('selectedNoteId');

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            }

            function setSelectedNoteId(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([CONFIG_STORE], 'readwrite');
                    const store = transaction.objectStore(CONFIG_STORE);
                    const request = store.put(id, 'selectedNoteId');

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            }

            // UI state
            let currentNoteId = null;
            let saveTimeout = null;

            // DOM elements
            const notesList = document.getElementById('notesList');
            const newNoteBtn = document.getElementById('newNoteBtn');
            const editorInput = document.getElementById('editorInput');
            const editorHighlight = document.getElementById('editorHighlight');
            const previewPane = document.getElementById('previewPane');
            const editorContent = document.getElementById('editorContent');
            const emptyState = document.getElementById('emptyState');
            const editorToolbar = document.getElementById('editorToolbar');
            const themeToggle = document.getElementById('themeToggle');

            // Markdown syntax highlighting function
            function highlightMarkdown(text) {
                let highlighted = text;

                // Escape HTML
                highlighted = highlighted.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                // Headers (# ## ### etc)
                highlighted = highlighted.replace(/^(#{1,6})\s+(.+?)$/gm,
                    '<span class="md-header">$1 $2</span>');

                // Inline code `code`
                highlighted = highlighted.replace(/`([^`]+)`/g,
                    '<span class="md-code">`$1`</span>');

                // Bold **text** or __text__
                highlighted = highlighted.replace(/(\*\*|__)([^*_]+)\1/g,
                    '<span class="md-bold">$1$2$1</span>');

                // Italic *text* or _text_
                highlighted = highlighted.replace(/(\*|_)([^*_]+)\1/g,
                    '<span class="md-italic">$1$2$1</span>');

                // Links [text](url)
                highlighted = highlighted.replace(/\[([^\]]+)\]\(([^)]+)\)/g,
                    '<span class="md-link">[$1]</span><span class="md-url">($2)</span>');

                // Blockquotes > text
                highlighted = highlighted.replace(/^&gt;\s+(.+?)$/gm,
                    '<span class="md-blockquote">&gt; $1</span>');

                // Lists - and * and +
                highlighted = highlighted.replace(/^(\s*)([*+-]|\d+\.)\s+/gm,
                    '$1<span class="md-list">$2</span> ');

                return highlighted;
            }

            function updateHighlight() {
                const text = editorInput.value;
                const highlighted = highlightMarkdown(text);
                editorHighlight.innerHTML = highlighted;
            }

            // Sync scrolling between textarea and highlight
            editorInput.addEventListener('scroll', () => {
                editorHighlight.scrollTop = editorInput.scrollTop;
                editorHighlight.scrollLeft = editorInput.scrollLeft;
            });

            // Export/Import functionality
            function downloadFile(content, filename, type = 'text/plain') {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async function exportAllNotes() {
                const notes = await getAllNotes();
                const exportData = {
                    version: 1,
                    exportedAt: new Date().toISOString(),
                    notes: notes
                };
                const jsonString = JSON.stringify(exportData, null, 2);
                const timestamp = new Date().toISOString().slice(0, 10);
                downloadFile(jsonString, `notes-export-${timestamp}.json`, 'application/json');
            }

            async function importNotes(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = async (e) => {
                        try {
                            const importData = JSON.parse(e.target.result);
                            if (!importData.notes || !Array.isArray(importData.notes)) {
                                reject(new Error('Invalid import format'));
                                return;
                            }

                            let importedCount = 0;
                            for (const note of importData.notes) {
                                const newNote = {
                                    title: note.title || 'Imported Note',
                                    content: note.content || '',
                                    createdAt: note.createdAt || Date.now(),
                                    modifiedAt: Date.now()
                                };
                                await saveNote(newNote);
                                importedCount++;
                            }

                            await loadNotesList();
                            alert(`Successfully imported ${importedCount} note(s)`);
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };

                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }

            function exportCurrentNoteAsMarkdown() {
                if (currentNoteId === null) {
                    alert('No note selected');
                    return;
                }

                getNote(currentNoteId).then(note => {
                    if (note) {
                        const timestamp = new Date().toISOString().slice(0, 10);
                        const filename = `${note.title || 'note'}-${timestamp}.md`;
                        downloadFile(note.content, filename, 'text/markdown');
                    }
                });
            }

            // Theme management
            function initTheme() {
                const isDark = localStorage.getItem('darkMode') === 'true';
                if (isDark) {
                    document.body.classList.add('dark-mode');
                    themeToggle.textContent = '‚òÄÔ∏è Light Mode';
                    loadLightModeStyles();
                }
            }

            function loadLightModeStyles() {
                const link = document.querySelector('link[rel="stylesheet"]');
                if (link && link.href.includes('atom-one-dark')) {
                    // In light mode, the default CSS is sufficient
                    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css';
                }
            }

            themeToggle.addEventListener('click', () => {
                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', isDark);
                themeToggle.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';

                if (isDark) {
                    document.querySelector('link[rel="stylesheet"]').href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css';
                } else {
                    document.querySelector('link[rel="stylesheet"]').href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css';
                }

                updatePreview();
            });

            // Note operations
            function createNewNote() {
                const note = {
                    title: 'Untitled Note',
                    content: '',
                    createdAt: Date.now(),
                    modifiedAt: Date.now()
                };

                saveNote(note).then(id => {
                    currentNoteId = id;
                    setSelectedNoteId(id);
                    loadNotesList();
                    selectNote(id);
                });
            }

            function selectNote(id) {
                currentNoteId = id;
                setSelectedNoteId(id);

                getNote(id).then(note => {
                    if (note) {
                        editorInput.value = note.content;
                        updateHighlight();
                        updateToolbar(note);
                        updatePreview();
                        editorContent.style.display = 'flex';
                        emptyState.style.display = 'none';

                        // Update active state in list
                        document.querySelectorAll('.note-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        document.querySelector(`[data-note-id="${id}"]`)?.classList.add('active');
                    }
                });
            }

            function updateToolbar(note) {
                const created = new Date(note.createdAt).toLocaleString();
                const modified = new Date(note.modifiedAt).toLocaleString();
                editorToolbar.textContent = `Created: ${created} | Modified: ${modified}`;
            }

            function updatePreview() {
                const content = editorInput.value;
                const html = marked.parse(content);
                previewPane.innerHTML = html;

                // Highlight code blocks
                previewPane.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            }

            function saveCurrentNote() {
                if (currentNoteId === null) return;

                getNote(currentNoteId).then(note => {
                    if (note) {
                        note.content = editorInput.value;
                        note.modifiedAt = Date.now();

                        // Extract title from first line or use "Untitled"
                        const lines = note.content.split('\n');
                        let title = lines[0].replace(/^#+\s*/, '').trim();
                        if (!title) {
                            title = lines.find(line => line.trim() !== '')?.substring(0, 15) || 'Untitled Note';
                        } else {
                            title = title.substring(0, 15);
                        }
                        note.title = title || 'Untitled Note';

                        saveNote(note).then(() => {
                            loadNotesList();
                            updateToolbar(note);
                        });
                    }
                });
            }

            function autoSaveNote() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveCurrentNote, 1000);
            }

            // Load and display notes
            async function loadNotesList() {
                const notes = await getAllNotes();
                notesList.innerHTML = '';

                if (notes.length === 0) {
                    editorContent.style.display = 'none';
                    emptyState.style.display = 'flex';
                    editorToolbar.textContent = 'No notes yet';
                    return;
                }

                notes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = 'note-item';
                    li.setAttribute('data-note-id', note.id);
                    if (note.id === currentNoteId) {
                        li.classList.add('active');
                    }
                    li.style.position = 'relative';

                    const title = document.createElement('div');
                    title.className = 'note-item-title';
                    title.textContent = note.title;

                    const date = document.createElement('div');
                    date.className = 'note-item-date';
                    date.textContent = new Date(note.modifiedAt).toLocaleDateString();

                    const actions = document.createElement('div');
                    actions.className = 'note-item-actions';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-note-btn';
                    deleteBtn.textContent = 'üóëÔ∏è';
                    deleteBtn.title = 'Delete note';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete "${note.title}"? This cannot be undone.`)) {
                            deleteNote(note.id).then(() => {
                                if (currentNoteId === note.id) {
                                    currentNoteId = null;
                                }
                                loadNotesList();
                                // Select another note or show empty state
                                getAllNotes().then(remainingNotes => {
                                    if (remainingNotes.length > 0) {
                                        selectNote(remainingNotes[0].id);
                                    } else {
                                        editorContent.style.display = 'none';
                                        emptyState.style.display = 'flex';
                                        editorToolbar.textContent = 'No notes yet';
                                    }
                                });
                            });
                        }
                    });

                    actions.appendChild(deleteBtn);

                    li.appendChild(title);
                    li.appendChild(date);
                    li.appendChild(actions);

                    li.addEventListener('click', () => selectNote(note.id));

                    notesList.appendChild(li);
                });
            }

            async function initializeApp() {
                await initDatabase();

                let notes = await getAllNotes();

                if (notes.length === 0) {
                    createNewNote();
                } else {
                    const selectedId = await getSelectedNoteId();
                    if (selectedId && notes.some(n => n.id === selectedId)) {
                        currentNoteId = selectedId;
                    } else {
                        currentNoteId = notes[0].id;
                    }
                    await loadNotesList();
                    selectNote(currentNoteId);
                }
            }

            // Get header elements
            const exportAllBtn = document.getElementById('exportAllBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');

            // Event listeners
            newNoteBtn.addEventListener('click', createNewNote);
            editorInput.addEventListener('input', () => {
                updateHighlight();
                updatePreview();
                autoSaveNote();
            });

            exportAllBtn.addEventListener('click', exportAllNotes);

            importBtn.addEventListener('click', () => {
                importFile.click();
            });

            importFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importNotes(e.target.files[0])
                        .catch(error => alert('Import failed: ' + error.message));
                    e.target.value = '';
                }
            });

            // Right-click context menu for exporting current note
            editorInput.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const menu = document.createElement('div');
                menu.style.cssText = `
                    position: fixed;
                    top: ${e.clientY}px;
                    left: ${e.clientX}px;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    z-index: 1000;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                `;

                const menuItem = document.createElement('div');
                menuItem.textContent = 'Export as Markdown';
                menuItem.style.cssText = `
                    padding: 8px 16px;
                    cursor: pointer;
                    color: var(--text-primary);
                    font-size: 14px;
                    transition: background-color 0.2s;
                `;
                menuItem.addEventListener('mouseenter', () => {
                    menuItem.style.backgroundColor = 'var(--bg-primary)';
                });
                menuItem.addEventListener('mouseleave', () => {
                    menuItem.style.backgroundColor = 'transparent';
                });
                menuItem.addEventListener('click', () => {
                    exportCurrentNoteAsMarkdown();
                    document.body.removeChild(menu);
                });

                menu.appendChild(menuItem);
                document.body.appendChild(menu);

                setTimeout(() => {
                    if (document.body.contains(menu)) {
                        document.body.removeChild(menu);
                    }
                }, 5000);

                document.addEventListener('click', () => {
                    if (document.body.contains(menu)) {
                        document.body.removeChild(menu);
                    }
                }, { once: true });
            });

            // Initialize app
            initTheme();
            initializeApp();
        </script>
    </body>

</html>